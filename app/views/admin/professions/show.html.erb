<%# app/views/admin/professions/show.html.erb %>

<h1><%= fix_encoding(@profession.name) %></h1>

<% current_status = params[:status].presence || "approved" %>

<nav style="margin-bottom:1rem;">
  <strong>Voir :</strong>
  <%= link_to "Approved", admin_profession_path(@profession, status: "approved") %> |
  <%= link_to "Pending",  admin_profession_path(@profession, status: "pending") %> |
  <%= link_to "Rejected", admin_profession_path(@profession, status: "rejected") %> |
  <%= link_to "All",      admin_profession_path(@profession, status: "all") %> |
  <%= link_to "← Retour au référentiel", admin_professions_path(species: params[:species]) %>
</nav>

<%# Compteurs par statut (pour cette profession) %>
<% counts = ProfessionMapping.where(profession_id: @profession.id).group(:status).count %>
<p style="margin:.25rem 0 1rem;">
  <strong>Compteurs</strong> —
  Approved: <%= counts["approved"] || 0 %> ·
  Pending:  <%= counts["pending"]  || 0 %> ·
  Rejected: <%= counts["rejected"] || 0 %>
</p>

<% if @possible_duplicates.any? %>
  <div style="border:1px solid #ccc; padding:8px; margin-bottom:12px;">
    <strong>Doublons potentiels (même name_norm) :</strong>
    <ul>
      <% @possible_duplicates.each do |dup| %>
        <li>
          <%= fix_encoding(dup.name) %>
          <%= form_with url: merge_into_admin_profession_path(@profession), method: :post, local: true, style: "display:inline;margin-left:8px;" do %>
            <%= hidden_field_tag :target_id, dup.id %>
            <%= submit_tag "Fusionner cette fiche dans « #{fix_encoding(dup.name)} »" %>
          <% end %>
        </li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="table-wrap">
  <div class="table-scroll">
    <table class="cp-table">
      <thead>
        <tr>
          <th>Compagnie</th>
          <th>Libellé compagnie</th>
          <th>Statut</th>
          <th>Score</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @mappings.each do |m| %>
          <% cp = m.carrier_profession %>
          <% carrier_name = cp&.carrier_referential&.carrier&.name %>
          <% status = m.status.to_s %>

          <% badge_class =
              case status
              when "approved" then "approved"
              when "pending"  then "pending"
              when "rejected" then "rejected"
              else "unmapped"
              end %>

          <tr class="data-row">
            <td><span class="pill"><%= fix_encoding(carrier_name) %></span></td>
            <td><strong><%= fix_encoding(cp&.external_label) %></strong></td>
            <td><span class="badge <%= badge_class %>"><%= status %></span></td>
            <td><%= m.confidence ? number_to_percentage((m.confidence.to_f * 100.0).round, precision: 0) : "-" %></td>
            <td>
              <%= link_to "Changer",
                          edit_admin_profession_mapping_path(m, species: params[:species], status: current_status),
                          class: "btn-link" %>
            </td>
          </tr>
        <% end %>

        <% if @mappings.blank? %>
          <tr>
            <td colspan="5" class="muted ta-center">Aucun mapping pour ce filtre.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
