<h1 class="cp-title">R√©f√©rentiel OGGO</h1>

<!-- üîπ ONGlets Chiens / Chats -->
<div class="tabs" style="display:flex; gap:8px; margin: 8px 0 12px;">
  <% base_params = request.query_parameters.except(:page).symbolize_keys %>
  <% active = ->(sp){ (params[:species].presence || "") == sp ? "background:#ede9fe; font-weight:600;" : "" } %>

  <%= link_to "üê∂ Chiens",
      admin_professions_path(base_params.merge(species: "dog", page: 1)),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{active.call('dog')}" %>

  <%= link_to "üê± Chats",
      admin_professions_path(base_params.merge(species: "cat", page: 1)),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{active.call('cat')}" %>
</div>

<div class="card">
  <%= form_with url: admin_professions_path,
                method: :get,
                local: true,
                data: { turbo: false },
                html: { id: "filters-form" } do %>

    <%= hidden_field_tag :species, @species if @species.present? %>

    <div class="filters-row">
      <label>Recherche</label>
      <%= text_field_tag :q, @q, placeholder: "ex: berger, siamois‚Ä¶", class: "inp", autofocus: true %>

      <label>Pr√©sence</label>
      <%= select_tag :company_span,
            options_for_select([["Pr√©sent dans 1 compagnie","one"],["Pr√©sent dans ‚â•2 compagnies","multi"]], @company_span),
            include_blank: "‚Äî pr√©sence (optionnel) ‚Äî",
            class: "sel" %>

      <label>Par page</label>
      <%= select_tag :per_page,
            options_for_select([50,100,200,500,1000], @per_page),
            class: "sel",
            onchange: 'this.form.submit();' %>

      <%= hidden_field_tag :page, 1 %>

      <%= submit_tag "Rechercher", class: "btn" %>

      <% if @q.present? || @company_span.present? || params[:per_page].present? || @species.present? %>
        <%= link_to "R√©initialiser", admin_professions_path, class: "btn secondary" %>
      <% end %>
    </div>

    <div class="filters-row" style="margin-top:10px;">
      <%= link_to "‚¨áÔ∏è Export CSV R√©f√©rentiel + Compagnies",
                  admin_professions_matrix_path(format: :csv),
                  class: "btn secondary",
                  data: { turbo: false } %>

      <%= link_to "‚¨áÔ∏è Export PHP (avec alias)",
                  admin_professions_php_path(include_aliases: 1),
                  class: "btn secondary",
                  data: { turbo: false } %>

      <%= link_to "‚¨áÔ∏è Export PHP R√©f√©rentiel",
                  admin_professions_php_path,
                  class: "btn secondary",
                  data: { turbo: false } %>
    </div>
  <% end %>
</div>

<div class="toolbar" style="margin: 8px 0;">
  <span class="muted">
    <strong><%= @total.to_i %></strong> r√©sultat<%= 's' if @total.to_i != 1 %>
  </span>

  <% if @total_pages.to_i > 1 %>
    <% total_pages_sane = [@total_pages.to_i, 1].max %>
    <% prev_params = request.query_parameters.merge(page: (@page.to_i - 1).clamp(1, total_pages_sane), per_page: @per_page) %>
    <% next_params = request.query_parameters.merge(page: (@page.to_i + 1).clamp(1, total_pages_sane), per_page: @per_page) %>

    <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
      <%= link_to "‚Üê Pr√©c√©dent", admin_professions_path(prev_params), class: "btn", disabled: (@page.to_i <= 1) %>
      <span class="muted">Page <%= @page.to_i %> / <%= @total_pages.to_i %></span>
      <%= link_to "Suivant ‚Üí", admin_professions_path(next_params), class: "btn", disabled: (@page.to_i >= @total_pages.to_i) %>
    </div>
  <% end %>
</div>

<div class="table-wrap">
  <div class="table-scroll">
    <table class="cp-table">
      <thead>
        <tr>
          <th>Animal OGGO</th>
          <th class="w-120 ta-center">Nb compagnies</th>
          <th class="w-120 ta-right">Action</th>
        </tr>
      </thead>
      <tbody>
        <% if @professions.present? %>
          <% @professions.each do |p| %>
            <tr class="data-row">
              <td><strong><%= p.name %></strong></td>
              <td class="ta-center">
                <span class="pill"><%= p.try(:carriers_count).to_i %></span>
              </td>
              <td class="ta-right">
                <%= link_to "D√©tails", admin_profession_path(p, status: "approved"),
                    class: "btn secondary", style: "padding:4px 10px; font-size:14px;" %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="3" class="muted ta-center">Aucun r√©sultat.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>


<% if @total_pages.to_i > 1 %>
  <% total_pages_sane = [@total_pages.to_i, 1].max %>
  <% prev_params = request.query_parameters.merge(page: (@page.to_i - 1).clamp(1, total_pages_sane), per_page: @per_page) %>
  <% next_params = request.query_parameters.merge(page: (@page.to_i + 1).clamp(1, total_pages_sane), per_page: @per_page) %>

  <div class="toolbar" style="justify-content:flex-end;">
    <%= link_to "‚Üê Pr√©c√©dent", admin_professions_path(prev_params), class: "btn", disabled: (@page.to_i <= 1) %>
    <span class="muted">Page <%= @page.to_i %> / <%= @total_pages.to_i %></span>
    <%= link_to "Suivant ‚Üí", admin_professions_path(next_params), class: "btn", disabled: (@page.to_i >= @total_pages.to_i) %>
  </div>
<% end %>
