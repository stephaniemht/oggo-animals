<%# app/views/admin/merge_suggestions/_logs.html.erb %>

<div class="logs-page">
  <!-- on met TOUT dans logs-section pour que le JS puisse déléguer les events -->
  <div id="logs-section">

    <div class="filters-row">
      <input type="text" id="log-search" class="inp" placeholder="Rechercher un libellé ou une date...">

      <label class="inp" style="display:inline-flex; align-items:center; gap:6px; margin-bottom:0;">
        <input type="checkbox" id="select-all-logs">
        <span>Tout cocher / décocher</span>
      </label>

      <button id="bulk-undo-btn" type="button" class="btn secondary">
        Undo la sélection
      </button>
    </div>

    <div class="table-wrap table-scroll">
      <% if @logs.blank? %>
        <p class="muted" style="margin:0; padding:12px;">Aucun log pour le moment.</p>
      <% else %>
        <table class="cp-table">
          <thead>
            <tr>
              <th></th>
              <th>Quand</th>
              <th>Source (fusionné)</th>
              <th>Cible (métier final)</th>
              <th>Statut</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% @logs.each do |log| %>
              <% raw_source = (log.source_attrs || {})["name"].presence || "##{log.source_id}" %>
              <% raw_target = (@targets_by_id || {})[log.target_id] || "##{log.target_id}" %>

              <% source_label = fix_encoding(raw_source) %>
              <% target_label = fix_encoding(raw_target) %>
              <% when_txt     = (log.performed_at || log.created_at) %>

              <tr class="data-row log-row"
                  data-search="<%= [source_label, target_label, when_txt&.strftime('%d/%m/%Y %H:%M')].join(' ').downcase %>">
                <td><input type="checkbox" class="log-checkbox" value="<%= log.id %>"></td>

                <td>
                  <%= l(when_txt, format: :short) rescue when_txt %>
                </td>

                <td class="log-source"><%= source_label %></td>
                <td class="log-target"><%= target_label %></td>

                <td>
                  <% if log.undone_at.present? %>
                    <span class="badge rejected">
                      Annulé le <%= l(log.undone_at, format: :short) %>
                    </span>
                  <% else %>
                    <span class="badge approved">Actif</span>
                  <% end %>
                </td>

                <td>
                  <button type="button"
                          class="btn secondary single-undo-btn"
                          data-id="<%= log.id %>"
                          <%= 'disabled="disabled"' if log.undone_at.present? %>>
                    Undo
                  </button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    </div>

  </div>
</div>
