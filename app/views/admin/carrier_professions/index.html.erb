<h1 class="cp-title">Animaux des compagnies</h1>

<!-- üîπ Onglets esp√®ces -->
<div style="display:flex; gap:8px; margin: 8px 0 12px;">
  <% base_params = request.query_parameters.except(:page).symbolize_keys %>
  <% current_species = params[:species].presence_in(%w[dog cat]) %>

  <!-- toutes esp√®ces = pas de param -->
  <%= link_to "üåç Toutes esp√®ces",
      admin_carrier_professions_path(base_params.merge(species: nil, page: 1)),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{current_species.nil? ? 'background:#ede9fe; font-weight:600;' : ''}" %>

  <%= link_to "üê∂ Chiens",
      admin_carrier_professions_path(base_params.merge(species: "dog", page: 1)),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{current_species=='dog' ? 'background:#ede9fe; font-weight:600;' : ''}" %>

  <%= link_to "üê± Chats",
      admin_carrier_professions_path(base_params.merge(species: "cat", page: 1)),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{current_species=='cat' ? 'background:#ede9fe; font-weight:600;' : ''}" %>
</div>

<!-- ==== FORMULAIRE DE FILTRES (GET) ==== -->
<div class="card">
  <%= form_with url: admin_carrier_professions_path, method: :get, local: true,
                html: { id: "filters-form" } do %>

    <%# on ne propage l‚Äôesp√®ce que si on est vraiment sur dog/cat %>
    <% if current_species.present? %>
      <%= hidden_field_tag :species, current_species %>
    <% end %>

    <div class="filters-row">
      <label>Recherche</label>
      <%= text_field_tag :q, @q, placeholder: "ex: Siamois, Berger allemand, etc .. ", class: "inp" %>

      <label>Compagnie</label>
      <%= select_tag :carrier_id,
            options_from_collection_for_select(@carriers, :id, :name, params[:carrier_id]),
            include_blank: "Toutes compagnies",
            class: "sel" %>

      <label>Statut</label>
      <% status_opts = [["All","all"],["Unmapped","unmapped"],["Approved","approved"],["Pending","pending"],["Rejected","rejected"]] %>
      <%= select_tag :status, options_for_select(status_opts, @status), class: "sel" %>

      <label style="display:inline-flex; align-items:center; gap:8px;">
        <%= check_box_tag :only_once, "1", @only_once %>
        Pr√©sent dans une seule compagnie
      </label>

      <%= submit_tag "Filtrer", class: "btn" %>
      <% if params[:carrier_id].present? || @q.present? || @status != "all" || @only_once || current_species.present? %>
        <%= link_to "R√©initialiser",
                    admin_carrier_professions_path,
                    class: "btn secondary" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- ==== FORMULAIRE DE S√âLECTION (POST) ==== -->
<%= form_with url: bulk_select_admin_carrier_professions_path, method: :post, local: true,
              html: { id: "bulk-form", "data-turbo": "false" } do %>

  <%# pareil, on ne renvoie species que si on est sur chien/chat %>
  <% if current_species.present? %>
    <%= hidden_field_tag :species, current_species %>
  <% end %>

  <div class="table-wrap">
    <div class="toolbar">
      <label class="muted" style="display:inline-flex; align-items:center; gap:8px;">
        <input type="checkbox" id="check-all">
        <span>Tout s√©lectionner (cette page)</span>
      </label>

      <%= select_tag :bulk_action,
            options_for_select([
              ["‚Äî Choisir une action ‚Äî", ""],
              ["Changer en masse (assigner √† une profession)", "bulk_assign"],
              ["Passer le statut en 'approved'", "mark_approved"],
              ["Passer le statut en 'rejected'", "mark_rejected"]
            ]),
            class: "sel",
            required: true %>

      <%= submit_tag "Appliquer", id: "bulk-submit", class: "btn secondary" %>

      <span id="sel-count" class="muted" style="margin-left:8px;">0 s√©lection</span>

      <% if @carrier_professions.respond_to?(:size) %>
        <span style="margin-left:auto;" class="muted">
          <span class="pill"><%= @carrier_professions.size %></span> lignes
        </span>
      <% end %>
    </div>

    <div class="table-scroll">
      <table class="cp-table">
        <thead>
          <tr>
            <th class="w-48"></th>
            <th>Compagnie</th>
            <th>Libell√© compagnie</th>
            <th>Proposition OGGO</th>
            <th class="ta-right">Nb compagnies</th>
            <th>Statut</th>
            <th class="w-120">Action</th>
          </tr>
        </thead>
        <tbody>
          <% @carrier_professions.each do |cp| %>
            <% carrier = cp.carrier_referential.carrier.name %>

            <%# mapping actif (non rejet√©) s'il existe %>
            <% m_active = cp.profession_mappings.detect { |pm| pm.status != "rejected" && pm.profession.present? } %>

            <%# statut affich√© :
               - unmapped si aucun mapping du tout
               - rejected si pr√©sents mais tous rejet√©s
               - sinon statut du mapping actif %>
            <% row_status =
                if m_active
                  m_active.status
                else
                  cp.profession_mappings.any? ? "rejected" : "unmapped"
                end %>

            <% badge_class =
                case row_status
                when "approved" then "approved"
                when "pending"  then "pending"
                when "rejected" then "rejected"
                else "unmapped"
                end %>

            <tr class="data-row">
              <td>
                <%= check_box_tag "ids[]", cp.id, false, class: "row-check" %>
              </td>

              <td><span class="pill"><%= fix_encoding(carrier) %></span></td>

              <!-- ‚úÖ nettoyage encodage -->
              <td><strong><%= fix_encoding(cp.external_label) %></strong></td>

              <td>
                <% if m_active&.profession %>
                  <strong><%= fix_encoding(m_active.profession.name) %></strong>
                <% else %>
                  <span class="muted">(pas de mapping)</span>
                <% end %>
              </td>

              <td class="ta-right">
                <% if m_active&.profession_id %>
                  <% nb = @carriers_count_by_prof[m_active.profession_id].to_i %>
                  <span class="pill"><%= nb %></span>
                <% else %>
                  <span class="muted">-</span>
                <% end %>
              </td>

              <td>
                <span class="badge <%= badge_class %>"><%= row_status %></span>
              </td>

              <td>
                <% if m_active %>
                  <%= link_to "Changer",
                              edit_admin_profession_mapping_path(m_active, species: current_species),
                              class: "btn-link" %>
                <% else %>
                  <span class="muted">(aucune action)</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<script>
  // Petit confort : compteur s√©lection + "tout cocher"
  (function() {
    const bulk = document.getElementById("bulk-form");
    if (!bulk) return;

    const checkAll = bulk.querySelector("#check-all");
    const rows     = () => Array.from(bulk.querySelectorAll(".row-check"));
    const counter  = bulk.querySelector("#sel-count");

    function refreshCount() {
      const n = rows().filter(cb => cb.checked).length;
      if (counter) counter.textContent = n + " s√©lection" + (n > 1 ? "s" : "");
    }

    if (checkAll) {
      checkAll.addEventListener("change", () => {
        rows().forEach(cb => cb.checked = checkAll.checked);
        refreshCount();
      });
    }

    bulk.addEventListener("change", (e) => {
      if (e.target && e.target.classList.contains("row-check")) refreshCount();
    });

    refreshCount();
  })();
</script>
