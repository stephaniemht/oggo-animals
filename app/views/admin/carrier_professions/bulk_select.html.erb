<h1 class="cp-title">Changer en masse</h1>

<!-- üîπ ONGlets esp√®ces -->
<div style="display:flex; gap:8px; margin: 8px 0 12px;">
  <% current_species = params[:species].presence_in(%w[dog cat]) || "dog" %>
  <% base_params = request.query_parameters.symbolize_keys %>

  <%= link_to "üê∂ Chiens",
      bulk_select_admin_carrier_professions_path(base_params.merge(species: "dog")),
      class: "btn",
      data: { turbo: false },
      style: "padding:8px 12px; border-radius:12px; #{current_species=='dog' ? 'background:#ede9fe; font-weight:600;' : ''}" %>

  <%= link_to "üê± Chats",
      bulk_select_admin_carrier_professions_path(base_params.merge(species: "cat")),
      class: "btn",
      data: { turbo: false },
      style: "padding:8px 12px; border-radius:12px; #{current_species=='cat' ? 'background:#ede9fe; font-weight:600;' : ''}" %>
</div>

<!-- ===== S√âLECTION R√âSUM√â ===== -->
<% if @selected.present? %>
  <div class="card" style="margin-bottom:12px;">
    <p style="margin:0 0 8px;">
      <strong style="font-size:16px;"><%= @selected.size %></strong> √©l√©ments s√©lectionn√©s :
    </p>
    <ul style="margin:0; padding-left:18px; max-height:180px; overflow:auto;">
      <% @selected.first(10).each do |cp| %>
        <li style="margin:4px 0;">
          <span class="pill"><%= cp.carrier_referential.carrier.name %></span>
          <span style="margin-left:8px; font-weight:600; color:#111827;"><%= cp.external_label %></span>
        </li>
      <% end %>
    </ul>
    <% if @selected.size > 10 %>
      <p class="muted" style="margin:6px 0 0;">‚Ä¶ et <%= @selected.size - 10 %> autres.</p>
    <% end %>
  </div>
<% else %>
  <div class="card">‚ö†Ô∏è Aucun √©l√©ment s√©lectionn√©.</div>
<% end %>

<!-- ===== RECHERCHE DE CIBLE OGGO (GET) ===== -->
<div class="card" style="margin-bottom:12px;">
  <%= form_with url: bulk_select_admin_carrier_professions_path,
                method: :get,
                local: true,
                data: { turbo: false },
                html: { style: "margin:0;" } do %>
    <% @ids.each { |id| concat hidden_field_tag("ids[]", id) } %>


    <%= hidden_field_tag :species, current_species %>

    <div class="filters-row">
      <label>Rechercher un animal OGGO</label>
      <%= text_field_tag :q, @q, placeholder: "ex: berger, siamois‚Ä¶", class: "inp" %>

      <%= submit_tag "Rechercher", class: "btn" %>

      <% if @q.present? || @kind.present? %>
        <%= link_to "R√©initialiser",
                    bulk_select_admin_carrier_professions_path(ids: @ids, species: current_species),
                    class: "btn secondary",
                    data: { turbo: false } %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- ===== R√âSULTATS ===== -->
<% if @q.present? %>
  <% if @candidates.any? %>
    <div class="table-wrap">
      <div class="table-scroll">
        <table class="cp-table">
          <thead>
            <tr>
              <th>Profession OGGO</th>
              <th class="w-120">Nb compagnies</th>
              <th class="w-260">Assigner</th>
            </tr>
          </thead>
          <tbody>
            <% @candidates.each do |p| %>
              <tr class="data-row">
                <td><strong><%= p.name %></strong></td>
                <td><span class="pill"><%= p.try(:carriers_count).to_i %></span></td>
                <td>
                  <%= form_with url: bulk_assign_admin_carrier_professions_path,
                                method: :post,
                                local: true,
                                data: { turbo: false },
                                html: { style: "margin:0;" } do %>
                    <% @ids.each { |id| concat hidden_field_tag("ids[]", id) } %>
                    <%= hidden_field_tag :species, current_species %>
                    <%= hidden_field_tag :q, @q %>
                    <%= hidden_field_tag :profession_id, p.id %>
                    <%= submit_tag "Assigner √† ¬´ #{p.name} ¬ª (#{@selected.size})", class: "btn secondary" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <div class="card">
      <p class="muted" style="margin:0;">Aucun r√©sultat. Ajuste la recherche.</p>
    </div>
  <% end %>
<% end %>

<p style="margin-top:12px;">
  <%= link_to "‚Üê Retour √† la liste",
              admin_carrier_professions_path(species: current_species),
              class: "btn-link" %>
</p>
