<h1 class="cp-title">RÃ©attribuer le mapping</h1>

<% cp = @mapping.carrier_profession %>
<% current_species = (@species.presence_in(%w[dog cat]) || "dog") %>

<!-- ðŸ”¹ Onglets espÃ¨ces -->
<div style="display:flex; gap:8px; margin: 8px 0 12px;">
  <%= link_to "ðŸ¶ Chiens",
      edit_admin_profession_mapping_path(@mapping, species: "dog", q: params[:q]),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{current_species=='dog' ? 'background:#ede9fe; font-weight:600;' : ''}" %>

  <%= link_to "ðŸ± Chats",
      edit_admin_profession_mapping_path(@mapping, species: "cat", q: params[:q]),
      class: "btn",
      style: "padding:8px 12px; border-radius:12px; #{current_species=='cat' ? 'background:#ede9fe; font-weight:600;' : ''}" %>
</div>

<!-- ===== RÃ‰SUMÃ‰ DU MAPPING ACTUEL ===== -->
<div class="card" style="margin-bottom:12px;">
  <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;">
    <div>
      <div class="muted" style="text-transform:uppercase; font-weight:700; letter-spacing:.04em; margin-bottom:6px;">Compagnie</div>
      <div class="pill"><%= clean_encoding(cp.carrier_referential.carrier.name) %></div>
    </div>

    <div>
      <div class="muted" style="text-transform:uppercase; font-weight:700; letter-spacing:.04em; margin-bottom:6px;">LibellÃ© compagnie</div>
      <div style="font-weight:700; color:#111827;"><%= clean_encoding(cp.external_label) %></div>
    </div>

    <div>
      <div class="muted" style="text-transform:uppercase; font-weight:700; letter-spacing:.04em; margin-bottom:6px;">
        Proposition actuelle
      </div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span class="pill"><%= @mapping.profession ? clean_encoding(@mapping.profession.name) : "-" %></span>
        <span class="muted">statut :</span>
        <span class="pill"><%= @mapping.status %></span>
        <span class="muted">prÃ©sent dans :</span>
        <span class="pill"><%= @current_carriers_count.to_i %></span>
        <span class="muted">compagnie(s)</span>
      </div>
    </div>
  </div>
</div>

<!-- ===== RECHERCHE (GET) ===== -->
<div class="card" style="margin-bottom:12px;">
  <%= form_with url: edit_admin_profession_mapping_path(@mapping), method: :get, local: true, html: { style: "margin:0;" } do %>
    <%= hidden_field_tag :species, current_species %>
    <div class="filters-row">
      <label>Rechercher un animal OGGO</label>
      <%= text_field_tag :q, @q, placeholder: "ex: berger, siamoisâ€¦", class: "inp" %>
      <%= submit_tag "Rechercher", class: "btn" %>
      <% if @q.present? %>
        <span class="muted">RÃ©sultats pour Â« <strong><%= clean_encoding(@q) %></strong> Â»</span>
      <% end %>
    </div>
  <% end %>
</div>

<!-- ===== RÃ‰SULTATS ===== -->
<% if @q.present? %>
  <% if @candidates.any? %>
    <div class="table-wrap">
      <div class="table-scroll">
        <table class="cp-table">
          <thead>
            <tr>
              <th>Animal OGGO</th>
              <th class="w-120 ta-center">Nb compagnies</th>
              <th class="w-220">Assigner</th>
            </tr>
          </thead>
          <tbody>
            <% @candidates.each do |p| %>
              <tr class="data-row">
                <td><strong><%= clean_encoding(p.name) %></strong></td>
                <td class="ta-center"><span class="pill"><%= p.try(:carriers_count).to_i %></span></td>
                <td>
                  <%= form_with url: assign_admin_profession_mapping_path(@mapping),
                                method: :post,
                                local: true,
                                data: { turbo: false },
                                html: { style: "margin:0;" } do %>
                    <%= hidden_field_tag :species, current_species %>
                    <%= hidden_field_tag :q, @q %>
                    <%= hidden_field_tag :profession_id, p.id %>
                    <%= submit_tag "Assigner", class: "btn secondary" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <div class="card">
      <p class="muted" style="margin:0;">Aucun rÃ©sultat. Ajuste la recherche.</p>
    </div>
  <% end %>
<% end %>

<p style="margin-top:12px;">
  <%= link_to "â† Retour Ã  la liste",
              admin_carrier_professions_path(species: current_species),
              class: "btn-link" %>
</p>
